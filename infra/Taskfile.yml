version: '3'

vars:
  K8S_DIR: k8s
  PROJECT_ROOT: ".."

tasks:
  default:
    desc: "Affiche la liste des tÃ¢ches"
    cmds:
      - task --list

  # ğŸš€ TÃ¢che principale : Tout dÃ©ployer (Build optionnel avant)
  up:
    desc: "DÃ©ploie la stack complÃ¨te en mode DEV (Secrets + DB + Apps)"
    cmds:
      - task: install
      - task: secrets
      - task: apps
      - echo "âœ… Tout est dÃ©ployÃ© ! Lance 'task status' pour vÃ©rifier."

  # ğŸ›‘ Nettoyage
  down:
    desc: "Supprime toutes les ressources du cluster"
    cmds:
      # Supprime ce qui est dÃ©fini dans Kustomize (Deployments, Services, StatefulSet)
      - kubectl delete -k {{.K8S_DIR}}/dev --ignore-not-found
      # Supprime les secrets (qui ne sont pas dans Kustomize)
      - kubectl delete secret api-secret bot-secret --ignore-not-found
      - echo "ğŸ—‘ï¸ Cluster nettoyÃ©."

  # ğŸ—ï¸ Build des images (Ã€ lancer si tu modifies le code TS)
  build:
    desc: "Construit les images API et Bot localement (NÃ©cessite 'eval $(minikube docker-env)')"
    cmds:
      - echo "ğŸ³ Construction de l'image API..."
      - docker build -t furby-api:local -f docker/api/Dockerfile {{.PROJECT_ROOT}}
      
      - echo "ğŸ³ Construction de l'image Bot..."
      - docker build -t furby-bot:local -f docker/discord/Dockerfile {{.PROJECT_ROOT}}
      
      - echo "âœ… Images 'local' prÃªtes dans Minikube."

  install:
    desc: "Installe Cert-Manager via Helm avec la config propre"
    cmds:
      - echo "ğŸ“¦ Mise Ã  jour des repos Helm..."
      - helm repo add jetstack https://charts.jetstack.io
      - helm repo update

      - echo "ğŸš€ Installation de Cert-Manager (v1.16.2)..."
      # upgrade --install : Installe si absent, met Ã  jour si prÃ©sent (Idempotent)
      - |
        helm upgrade --install cert-manager jetstack/cert-manager \
        --namespace cert-manager \
        --create-namespace \
        --version v1.16.2 \
        --values {{.K8S_DIR}}/cert-manager/values.yaml \
        --wait

      - echo "âœ… Cert-Manager est prÃªt !"

      - echo "ğŸš¦ Installation de Traefik..."
      - helm repo add traefik https://traefik.github.io/charts
      - helm repo update
      - |
        helm upgrade --install traefik traefik/traefik \
        --namespace traefik \
        --create-namespace \
        --set ports.web.nodePort=30080 \
        --set ports.websecure.nodePort=30443 \
        --wait

  # ğŸ” Secrets (SOPS)
  secrets:
    desc: "DÃ©chiffre et applique les secrets (Mode verbeux)"
    cmds:
      - echo "ğŸ§ Recherche des fichiers secrets.yaml dans {{.K8S_DIR}}..."
      # On force l'affichage des fichiers trouvÃ©s
      - find {{.K8S_DIR}} -name "secrets.yaml" -print
      
      - echo "ğŸ”“ Application..."
      # On utilise une boucle for pour voir les erreurs de chaque fichier
      - |
        for file in $(find {{.K8S_DIR}} -name "secrets.yaml"); do
          echo "Traitement de $file ..."
          sops -d "$file" | kubectl apply -f - || exit 1
        done

  # ğŸ“¦ Applications & DB (Via Kustomize Dev Overlay)
  apps:
    desc: "Applique la config DEV (Postgres + API + Bot)"
    cmds:
      - echo "ğŸš€ DÃ©ploiement via Kustomize (Overlay Dev)..."
      - kubectl kustomize --load-restrictor LoadRestrictionsNone {{.K8S_DIR}}/dev | kubectl apply -f -

  # ğŸ› ï¸ VÃ©rification
  status:
    desc: "Affiche l'Ã©tat des Pods, Services et Logs"
    cmds:
      - kubectl get pods,svc

  bootstrap-flux:
    desc: "Injecte la clÃ© de dÃ©chiffrement SOPS dans Flux (Ã€ faire une seule fois par cluster)"
    cmds:
      - echo "ğŸ”‘ Injection de la clÃ© Age dans le namespace flux-system..."
      # Assure-toi que keys.txt est bien dans ton .gitignore !
      - cat ../keys.txt | kubectl create secret generic sops-age --namespace=flux-system --from-file=age.agekey=/dev/stdin
      - echo "âœ… ClÃ© injectÃ©e ! Flux peut maintenant dÃ©chiffrer."
