version: '3'

vars:
  K8S_DIR: k8s
  PROJECT_ROOT: ".."

tasks:
  default:
    desc: "Affiche la liste des tÃ¢ches"
    cmds:
      - task --list

  # ğŸš€ TÃ¢che principale : Tout dÃ©ployer (Build optionnel avant)
  up:
    desc: "DÃ©ploie la stack complÃ¨te en mode DEV (Secrets + DB + Apps)"
    cmds:
      - task: secrets
      - task: apps
      - echo "âœ… Tout est dÃ©ployÃ© ! Lance 'task status' pour vÃ©rifier."

  # ğŸ›‘ Nettoyage
  down:
    desc: "Supprime toutes les ressources du cluster"
    cmds:
      # Supprime ce qui est dÃ©fini dans Kustomize (Deployments, Services, StatefulSet)
      - kubectl delete -k {{.K8S_DIR}}/dev --ignore-not-found
      # Supprime les secrets (qui ne sont pas dans Kustomize)
      - kubectl delete secret api-secret bot-secret --ignore-not-found
      - echo "ğŸ—‘ï¸ Cluster nettoyÃ©."

  # ğŸ—ï¸ Build des images (Ã€ lancer si tu modifies le code TS)
  build:
    desc: "Construit les images API et Bot localement (NÃ©cessite 'eval $(minikube docker-env)')"
    cmds:
      - echo "ğŸ³ Construction de l'image API..."
      - docker build -t furby-api:local -f docker/api/Dockerfile {{.PROJECT_ROOT}}
      
      - echo "ğŸ³ Construction de l'image Bot..."
      - docker build -t furby-bot:local -f docker/discord/Dockerfile {{.PROJECT_ROOT}}
      
      - echo "âœ… Images 'local' prÃªtes dans Minikube."

  # ğŸ” Secrets (SOPS)
  secrets:
    desc: "DÃ©chiffre et applique les secrets (Mode verbeux)"
    cmds:
      - echo "ğŸ§ Recherche des fichiers secrets.yaml dans {{.K8S_DIR}}..."
      # On force l'affichage des fichiers trouvÃ©s
      - find {{.K8S_DIR}} -name "secrets.yaml" -print
      
      - echo "ğŸ”“ Application..."
      # On utilise une boucle for pour voir les erreurs de chaque fichier
      - |
        for file in $(find {{.K8S_DIR}} -name "secrets.yaml"); do
          echo "Traitement de $file ..."
          sops -d "$file" | kubectl apply -f - || exit 1
        done

  # ğŸ“¦ Applications & DB (Via Kustomize Dev Overlay)
  apps:
    desc: "Applique la config DEV (Postgres + API + Bot)"
    cmds:
      - echo "ğŸš€ DÃ©ploiement via Kustomize (Overlay Dev)..."
      - kubectl kustomize --load-restrictor LoadRestrictionsNone {{.K8S_DIR}}/dev | kubectl apply -f -

  # ğŸ› ï¸ VÃ©rification
  status:
    desc: "Affiche l'Ã©tat des Pods, Services et Logs"
    cmds:
      - kubectl get pods,svc
